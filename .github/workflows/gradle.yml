name: Java CI/CD with Gradle

on:
  push:
    branches: [ "featcicd" ]
  pull_request:
    branches: [ "featcicd" ]

concurrency:
  group: shared-server-deployment
  cancel-in-progress: false  # 실행 중인 job 취소하지 않고 대기

jobs:
  build-and-deploy:
    runs-on: self-hosted
    environment: hub-cicd
    permissions:
      contents: read
      packages: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create application.yml from sample
        run: |
          cp src/main/resources/application-sample.yml src/main/resources/application.yml
          echo "application.yml created from sample"

      - name: Build with Gradle (including Testcontainers tests)
        env:
          GITHUB_USERNAME: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_USERNAME: ${{ secrets.POSTGRES_USERNAME }}
          REDIS_HOST: ${{ secrets.REDIS_HOST }}
          REDIS_PORT: ${{ secrets.REDIS_PORT }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        run: ./gradlew clean build

      - name: Deploy new version
        run: |
          JAR_PATH="build/libs/${{ secrets.JAR_NAME }}"
          DEPLOY_DIR="$HOME/${{ secrets.DEPLOY_DIR }}"
          LOG_DIR="$HOME/${{ secrets.LOG_DIR }}"
          
          mkdir -p $LOG_DIR
          mkdir -p $DEPLOY_DIR

          if [ -f "$DEPLOY_DIR/app.jar" ]; then
            mv "$DEPLOY_DIR/app.jar" "$DEPLOY_DIR/app.jar.bak.$(date +%Y%m%d_%H%M%S)"
          fi

          cp $JAR_PATH $DEPLOY_DIR/app.jar
          echo "JAR deployed"

      - name: Update environment variables
        
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USERNAME: ${{ secrets.POSTGRES_USERNAME }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_HOST: ${{ secrets.REDIS_HOST }}
          REDIS_PORT: ${{ secrets.REDIS_PORT }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          DB_CONNECTION_TIMEOUT: ${{ secrets.DB_CONNECTION_TIMEOUT }}
          DB_LOCK_TIME_OUT: ${{ secrets.DB_LOCK_TIME_OUT }}
          DB_POOL_SIZE: ${{ secrets.DB_POOL_SIZE }}
          HUB_SERVICE_CACHEABLE: ${{ secrets.HUB_SERVICE_CACHEABLE }}
          KAKAO_MOBILITY_API_KEY: ${{ secrets.KAKAO_MOBILITY_API_KEY }}
          PASSPORT_ALGO: ${{ secrets.PASSPORT_ALGO }}
          PASSPORT_EXPIRATION: ${{ secrets.PASSPORT_EXPIRATION }}
          PASSPORT_SECRET: ${{ secrets.PASSPORT_SECRET }}
        run: |
          cat > $HOME/${{ secrets.DEPLOY_DIR }}/.env << EOF
          POSTGRES_HOST=${POSTGRES_HOST}
          POSTGRES_PORT=${POSTGRES_PORT}
          POSTGRES_DB=${POSTGRES_DB}
          POSTGRES_USERNAME=${POSTGRES_USERNAME}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          REDIS_HOST=${REDIS_HOST}
          REDIS_PORT=${REDIS_PORT}
          REDIS_PASSWORD=${REDIS_PASSWORD}
          DB_CONNECTION_TIMEOUT=${DB_CONNECTION_TIMEOUT}
          DB_LOCK_TIME_OUT=${DB_LOCK_TIME_OUT}
          DB_POOL_SIZE=${DB_POOL_SIZE}
          HUB_SERVICE_CACHEABLE=${HUB_SERVICE_CACHEABLE}
          KAKAO_MOBILITY_API_KEY="${KAKAO_MOBILITY_API_KEY}"
          PASSPORT_ALGO=${PASSPORT_ALGO}
          PASSPORT_EXPIRATION=${PASSPORT_EXPIRATION}
          PASSPORT_SECRET=${PASSPORT_SECRET}
          EOF
          echo "Environment variables updated"

      - name: Restart application
        run: |
          $HOME/deploy/restart.sh ${{ secrets.APP_PORT }} ${{ secrets.DEPLOY_DIR }} ${{ secrets.LOG_DIR }}
          
          echo "Waiting for application to start..."
          sleep 10
          
          for i in {1..30}; do
          if lsof -ti:${{ secrets.APP_PORT }} > /dev/null 2>&1; then
           echo "Application is running on port ${{ secrets.APP_PORT }}"
           ps aux | grep app.jar | grep -v grep
           exit 0
          fi
          echo "Waiting... ($i/30)"
          sleep 2
          done
          
          echo "Application failed to start"
          tail -100 $HOME/${{ secrets.LOG_DIR }}/app.log
          exit 1
  
          - name: Verify deployment
            run: |
              sleep 5
              
              if lsof -ti:${{ secrets.APP_PORT }} > /dev/null; then
                echo "Deployment successful - Application is running on port ${{ secrets.APP_PORT }}"
              else
                echo "Deployment failed - Application is not running"
                tail -50 $HOME/${{ secrets.LOG_DIR }}/app.log
                exit 1
              fi
